---
layout: post
title:  "DevOps"
date:   2019-07-25 14:25:01 +0800
categories: 前后端技术
tag: 后端运维
---

* content
{:toc}


****

> **未经许可，严禁任何形式的转载！**


****

**参考**

- [DevOps 详解](https://www.infoq.cn/article/detail-analysis-of-devops)
- [一篇文了解 DevOps](https://www.jianshu.com/p/ef11f0326394)

****

> **DevOps 是一种方法论，其包含了一些原则和实践。而其中所用到的工具链，只是为这样的实践提供支持！**
>
> **工具链可能会很快更新换代，但是方法论很难过时！**

## 传统开发运维的困境

传统的软件开发与运维流程，存在诸多影响效率的因素，主要体现在如下几点：

### 工作目的的差异

行业管理者渴望加快产品的上市时间（`TTM`），又称为前置时间（`Lead Time`）。由于技术更新迭代迅速，市场发展千变万化，因此 `TTM` 是一项非常重要的 `KPI`（关键绩效指标）。

因此，产品需求决定了**开发**人员的目的，在于尽可能快速将想法变成成果，缩短前置时间。同时，对于**运维**人员，运维人员的目的又在于改善产品质量，进而提高服务的稳定性。

### 开发工具的差异

在传统的大型企业中，运维团队和开发团队分别使用专用的，没有什么交集的工具集，因此对于软件和开发环境等可能存在差异。

此外，由于公司制度，可能一些机密的运维信息，不便于提供给开发人员，例如生产系统的日志和监视日志等。

### 环境配置的差异

开发人员和运维人员的实际工作环境可能不同，其工作完成的标准也不同。

开发人员在自己的环境中开发完成，验证成功，然后将其推送给运维人员。而运维人员的测试环境可能与开发人员不一样，因此可能需要编写不同的测试脚本，并根据实际的生产环境和需求进行更迭。

这一过程会进行大量的重复性工作，且可能因为环境或需求变化，导致新的 `bug`。并且由于环境的更迭，可能并不存在之前环境的拷贝，导致无法进行回滚复现。

### 混乱之墙

开发和运维之间的这些隔阂，就称之为混乱之墙。

<div style="text-align:center">
<img src="/images/混乱之墙.jpeg" width="50%">
<p>混乱之墙</p>
</div><br>

## DevOps 的引入

针对混乱之墙导致的效率低下问题，`DevOps` 的概念于 `2009` 年左右开始兴起，但是直到近些年才逐渐流行。

###  DevOps 的内核

`DevOps` 一词的来自于 `Development` 和 `Operations` 的组合，突出重视软件开发人员和运维人员的沟通合作，通过**自动化流程**来使得软件构建、测试、发布更加快捷、频繁和可靠。

> **DevOps 是一种方法论，其包含了一些原则和实践。而其中所用到的工具链，只是为这样的实践提供支持！**

### DevOps 的目标

1. 进行软件产品交付过程中，**工具链的打通**，使得各个团队减少时间损耗，更加高效地协同工作。
2. 更侧重于通过**标准化开发环境和自动化交付流程**，从而改善交付工作的可预测性、效率、安全性，以及可维护性。
3. 可以为开发者提供更**可控的生产环境**，帮助他们更好地理解生产基础架构。

如下面 `DevOps` 能力图所示，良好的闭环可以大大增加整体的产出。

<div style="text-align:center">
<img src="/images/DevOps 能力环.png" width="65%">
<p>DevOps 能力环</p>
</div><br>

### DevOps 流行的原因

1. **技术发展成熟**

   `DevOps` 的实现可以基于新兴的容器技术；也可以在自动化运维工具 `Puppet`、`SaltStack`、`Ansible` 之后的延伸；还可以构建在传统的 `Cloud Foundry`、`OpenShift` 等 `PaaS` 厂商之上。

2. **市场变化迅速**

   `IT` 行业已经越来越与市场的经济发展紧密挂钩，专家们认为 `IT` 将会从支持中心变成利润驱动中心。

3. **提高工程师效率**

   对于工程师而言，他们也是 `DevOps` 的受益者。对于开发者而言，最有力的工具就是自动化工具。

   工具链的打通使得开发者们在交付软件时可以完成生产环境的构建、测试和运行。

### DevOps 的优点

1. **可重复性与可靠性**：

   如今，构建生产用计算机只需要运行脚本或必要的 `puppet` 命令即可。

   通过恰当地使用 `Docker` 容器或 `Vagrant` 虚拟机，只需运行**一条命令**即可配置好包含操作系统层以及所需软件和配置的生产用计算机。

   当然，随着各种变更或软件开发、持续集成，并自动测试，这套构建脚本或机制也会进行持续集成。

2. **生产力的提升**

   通过一键部署，一键供应，一键创建新环境等等，整个生产环境可以通过一条命令或一键点击的方式创建。

   这样的一条命令也许会运行长达数小时，但在这过程中运维人员可以从事其他更有趣的工作，而无需等待一条命令执行完毕后继续输入下一条命令。

3. **系统恢复时间**

   一键点击即可恢复生产环境，就是这么简单。

4. **确保基础架构的同质**

   彻底避免运维人员每次构建环境或安装软件时最终获得的结果与预期有所差异，这是确保基础架构绝对同质（`Homogeneous`）并且可再现的唯一可行方法。

   以此为基础，通过对脚本或 `Puppet` 配置文件使用版本控制机制，我们甚至可以重建出与上周、上个月，或软件特定版本发布时完全一致的生产环境。

5. **维持整齐划一的标准**

   基础架构标准甚至可以不复存在，代码本身就是标准.

6. **让开发者自行完成大部分工作**

   如果开发者自己突然可以在自己的基础架构上一键点击重建生产环境，他们也就可以自行完成很多与生产环境有关的任务，例如更好地理解生产失败，提供更恰当的配置，实现部署脚本等。

## DevOps 的三大原则

<div style="text-align:center">
<img src="/images/DevOps.png" width="55%">
<p>DevOps 三大原则</p>
</div><br>

### Infrastructure as Code

#### 基本概念

基础架构即代码，是绝大部分 `DevOps` 实践的前提要求，其包括版本控制、代码审阅、持续集成、自动化测试等任务脚本。

其包括计算基础架构（容器、虚拟机、物理机、软件安装等）的**管理**和**供应**，主要是通过配置文件或脚本，来替换交互式的配置工具和手工命令。

以非常概括的方式来看，基础架构和运维所需实现的自动化程度可通过下图这种架构来表示：

<div style="text-align:center">
<img src="/images/基础架构和运维所需实现的自动化程度.png" width="86%">
<p>基础架构和运维所需实现的自动化程度</p>
</div><br>

#### DevOps 工具链

基础架构的**版本控制**能力（而非基础架构的构建脚本或配置文件）及对其进行**自动化测试**的能力极其重要。此外基础架构元素应该能向软件交付物一样进行**持续集成**。

`DevOps` 个阶段及其工具类别如下所示：

- **编码**：代码开发和审阅，版本控制工具、代码合并工具
- **构建**：持续集成工具、构建状态统计工具
- **测试**：通过测试和结果确定绩效的工具
- **打包**：成品仓库、应用程序部署前暂存
- **发布**：变更管理、发布审批、发布自动化
- **配置**：基础架构配置和部署，基础架构即代码工具
- **监视**：应用程序性能监视、最终用户体验

### Continuous Delivery

#### 什么是持续交付

通过对生产环境中的应用程序进行更高频次的增量更新，这种方法有助于降低交付变更过程中涉及的成本、时间和风险。**足够简单直接并且可重复的部署流程对持续交付而言至关重要**。

**持续交付**是一种可以帮助团队以更短的周期交付软件的方法，该方法**确保了团队可以在任何时间发布出可靠的软件**。该方法意在以更快速度更高频率进行软件的构建、测试和发布。

**注意：持续交付 ≠ 持续部署** - 有时候很多人会把持续交付误认为成持续部署。持续部署是指每个变更可以自动部署到生产环境。持续交付是指团队确保每个变更可以部署至生产环境，但也许并不需要实际部署，这通常可能是出于业务方面的原因。只有成功实现持续交付的前提下，才能进行持续部署。

#### 关键实践

**从实践中学习**

持续交付的关键在于要能**从实践中学习**。真理并不存在于开发团队中，而在于业务用户中。敏捷方法论强调将功能提供给用户，并不惜一切代价从用户处获得尽可能多的反馈。

持续交付与持续部署类似，需要尽可能减少前置时间，这也是尽快从用户处获得“真理”的关键。

**自动化**

在没有将与基础架构有关的所有供应和任务实现妥善、全面的自动化之前，持续交付根本无从谈起。

生产团队中，将近一般的时间用于与部署相关的工作中，且随着运维手工执行命令的数目逐渐增多，一次性部署成功的概率将逐渐降低。因此，部署自动化是极其重要的。

这一点很重要：环境的搭建和生产就绪版本软件的部署只需要一键点击，只需要运行一条命令，整个过程应该自动完成。否则根本无法设想能一天多次部署同一个软件。

**更频繁的部署**

自动化测试、重构、数据库迁移、面向客户的产品规格、规划、发布等等，所有这些活动都要尽可能频繁地进行。

这种方式可以更快的获取反馈，提炼可自动化的步骤，此外还可以较少版本之间的差异。

<div style="text-align:center">
<img src="/images/任务拆解成小块.png" width="55%">
<p>频繁部署的优势</p>
</div><br>

### Culture of Collaboration

团队合作对 `DevOps` 是如此的重要，大部分方法论所要实现的最终目标总的来说可以通过两个 `C` 来实现：协作（`Collaboration`）和沟通（`Communication`）。

#### 软件开发流程

1. 业务代表与产品负责人以及架构团队合作定义软件
2. 开发团队迭代开发软件，并在每次更新后，将生产就绪版本的软件发布给业务用户，进而收集反馈并尽可能频繁地调整方向。
3. 在预定的时间里，运维应该给出自己的非功能需求。开发团队应该按照同等程度的重要性和优先级处理这种非功能需求。
4. 在实现的过程中，运维应该持续提供反馈和非功能测试规范
5. 通过采用 `DevOps` 方法，运维可以全面融入软件开发流程中。

#### 共享工具

这个目标其实很难实现，但是其有助于消除混乱之墙。这样做所能获得的收益远大于所需进行的投入，这种方法对整个公司的投资回报非常明显。

#### 协同工作

开发者和运维人员必须定期进行密切的合作。这就意味着他们必须将对方视作重要的利益相关者，并积极主动地寻求合作。

## 零停机部署 ZDD

> **零停机部署（`ZDD`）可在不中断现有服务的情况下部署新版系统。**

通过 `ZDD` 方式部署应用程序时，可在确保用户不会遭遇应用程序停机的前提下将新版应用引入生产环境。

从用户和公司的角度来看，这应该是最佳部署方式，因为可以在不造成任何中断的情况下引入新功能并修复 `Bug`。

零停机部署主要由以下几种方式。

### 功能开关

功能开关可供我们在软件运行过程中启用／禁用相应的功能。

这种技术其实非常容易理解和使用：为生产版本提供一个能彻底禁用某项功能的配置，并只在对应功能彻底完工可以正常工作后才将该属性激活。

### 摸黑启动

摸黑启动的目的在于通过实际生产环境进行负载模拟！

在测试环境中，通常很难为软件模拟出成百上千万用户规模的负载。如果不进行切实的负载测试，就无法知道基础架构能否承受住最终面临的压力。

此时并不需要模拟负载，而是可以实际部署这样的功能，然后看看在不影响可用性的前提下到底会发生什么。

假设我们要将一个有 `5` 亿用户使用的静态搜索字段变成一个包含自动补全功能的字段，借此让用户可以更快速获得搜索结果。为该功能构建一个 `Web` 服务，并且希望模拟所有用户同时输入文字，向该 `Web` 服务生成大量请求的场景。

此时即可通过摸黑启动策略为现有表单添加一个隐藏的后台进程，通过该进程将输入的搜索关键字发送给新增的自动补全服务，并自动发送多次。

就算新增的 `Web` 服务彻底崩溃了，也不会造成任何实质损害。网页上可以完全忽略服务器错误。而就算该服务崩溃了，我们至少还可以对该服务进行优化和完善，直到能承受如此大量的负载。

这就等于在现实世界中进行了一次负载测试。

### 蓝／绿部署

蓝／绿部署是指为下一版产品构建另一个完整的生产环境。开发和运维团队可以在这个单独的生产环境中放心地构建下一版产品。

当下一版产品全部完成后，可以修改负载均衡器的配置，以透明的方式将用户自动重定向至新发布的下一版。随后可将上一版的生产环境回收，用于构建下下一版的产品。以此类推。

这是一种相当有效简单的方法，但问题在于这种方式需要双倍的基础架构以及更多的服务器。

### 金丝雀发布

从本质来看，金丝雀发布与蓝／绿部署非常类似，但无需准备额外的一套生产环境。

这种方式的目标在于以增量的方式将用户切换至新版本：随着越来越多的服务器从当前版本迁移至下一版，相同比例的用户也会被同时迁移。

首先，只将少量服务器和少部分用户迁移至下一版，借此还可以在无须冒险影响所有用户的前提下对新版进行测试。

当所有服务器最终从当前版迁移至下一版后，发布工作已经完成，又可以从头开始准备下下一版了。

<div style="text-align:center">
<img src="/images/金丝雀部署.png" width="71%">
<p>金丝雀部署</p>
</div><br>